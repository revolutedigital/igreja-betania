generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Membro {
  id              String     @id @default(cuid())
  nome            String
  foto            String?    @db.Text
  nomePai         String?
  nomeMae         String?
  whatsapp        String     @unique
  dataAniversario DateTime?
  endereco        String?
  grupoPequeno    Boolean    @default(false)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  presencas       Presenca[]

  // √çndices para buscas frequentes
  @@index([nome])
  @@index([dataAniversario])
  @@index([grupoPequeno])
  @@index([createdAt])
}

model Culto {
  id        String     @id @default(cuid())
  data      DateTime
  horario   String
  createdAt DateTime   @default(now())
  presencas Presenca[]

  @@unique([data, horario])
  @@index([data])
  @@index([createdAt])
}

model Presenca {
  id        String   @id @default(cuid())
  membro    Membro   @relation(fields: [membroId], references: [id], onDelete: Cascade)
  membroId  String
  culto     Culto    @relation(fields: [cultoId], references: [id], onDelete: Cascade)
  cultoId   String
  presente  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([membroId, cultoId])
  @@index([cultoId])
  @@index([membroId])
  @@index([presente])
  @@index([createdAt])
}

model Usuario {
  id        String   @id @default(cuid())
  nome      String
  email     String   @unique
  senha     String
  role      String   @default("voluntario")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([createdAt])
}

// Model para logs de auditoria
model AuditLog {
  id        String   @id @default(cuid())
  action    String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity    String   // Membro, Presenca, Usuario, etc.
  entityId  String?
  userId    String?
  userName  String?
  details   String?  @db.Text
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([userId])
  @@index([createdAt])
}

// Model para push subscriptions
model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique
  p256dh    String
  auth      String
  userId    String?
  createdAt DateTime @default(now())

  @@index([userId])
}
